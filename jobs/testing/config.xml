<?xml version='1.0' encoding='UTF-8'?>
<flow-definition plugin="workflow-job@2.9">
  <actions/>
  <description></description>
  <keepDependencies>false</keepDependencies>
  <properties>
    <org.jenkinsci.plugins.workflow.job.properties.PipelineTriggersJobProperty>
      <triggers/>
    </org.jenkinsci.plugins.workflow.job.properties.PipelineTriggersJobProperty>
  </properties>
  <definition class="org.jenkinsci.plugins.workflow.cps.CpsFlowDefinition" plugin="workflow-cps@2.23">
    <script>node {
    // env.ffsitebranch = &apos;refs/tags/v0.2.90-stable.1&apos;
    // env.ffsitebranch = &quot;master&quot;
    env.ffsitebranch = &quot;gluon-2016.2.1&quot;
    
    wrap([$class: &apos;TimestamperBuildWrapper&apos;]) {
        timeout(time: 6, unit: &apos;HOURS&apos;) {
            ws {
                stage(&apos;Cleanup&apos;) {
                    deleteDir()
                }
                dir(&apos;site&apos;) {
                    stage(&apos;Checkout site.conf&apos;) {
                        checkout([$class: &apos;GitSCM&apos;, userRemoteConfigs: [[url: &apos;https://github.com/chris1911/site-ffka&apos;]], branches: [[name: env.ffsitebranch]]])
                    }

                    env.gluonBranch = sh([returnStdout: true, script: &apos;make -f jenkins.mk gluonbranch&apos;])
                    echo &apos;Corresponding gluon tag: &apos; + env.gluonbranch
                }
                
                dir(&apos;ffka&apos;) {
                    stage(&apos;Checkout gluon&apos;) {
                        def branchName = &apos;refs/tags/&apos; + env.gluonBranch
                        echo &apos;gluon-srcs: git branch name: &apos; + branchName
                        checkout([$class: &apos;GitSCM&apos;, userRemoteConfigs: [[url: &apos;https://github.com/freifunk-gluon/gluon&apos;]], branches: [[name: branchName]]])
                        sh &quot;ln -s ../site ./site&quot;
                    }
                    
                    stage(&apos;Update sub projects&apos;) {
                        sh &quot;make update&quot;
                    }
                    
                    def gluontargets = sh([returnStdout: true, script: &apos;make -f site/jenkins.mk targets&apos;])
                    String[] targets = gluontargets.trim().split(&apos; &apos;)
                    for (String target: targets) {
                        echo &apos;Building &apos; + target
                        cmd = &quot;make -j \$(nproc) GLUON_TARGET=&quot; + target
                        sh cmd + &quot; clean&quot;
                        sh cmd
                    }
                }
            }
        }
    }
}</script>
    <sandbox>true</sandbox>
  </definition>
  <triggers/>
</flow-definition>